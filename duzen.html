<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ürün Yönetimi</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f4f4f9;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #007bff;
            color: white;
        }
        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        input[type="file"] {
            margin: 10px 0;
        }
        #searchBar {
            margin-bottom: 20px;
            padding: 10px;
            width: 300px;
        }
    </style>
</head>
<body>
    <h1>Ürün Yönetimi</h1>

    <!-- Arama Kutusu -->
    <input type="text" id="searchBar" placeholder="Ürün ara..." onkeyup="searchProduct()">
    <br>

    <!-- Ürün Ekleme Formu -->
    <h2>Ürün Ekle</h2>
    <form id="productForm">
        <label>Ürün Adı: </label><input type="text" id="productName" required><br>
        <label>Kasa Kodu: </label><input type="text" id="productCode" required><br>
        <label>Ürün Görseli Linki: </label><input type="text" id="productImage"><br>
        <label>Migros Linki: </label><input type="text" id="migrosLink"><br>
        <button type="button" onclick="addProduct()">Ürün Ekle</button>
    </form>

    <!-- Aktarma Butonu -->
    <h2>Ürün Aktar</h2>
    <input type="file" id="fileInput" accept=".txt">
    <button onclick="importFile()">Aktar</button>

    <!-- Ürün Listesi -->
    <h2>Ürün Listesi</h2>
    <table>
        <thead>
            <tr>
                <th>Ürün Adı</th>
                <th>Kasa Kodu</th>
                <th>Ürün Resmi</th>
                <th>Migros Linki</th>
                <th>İşlem</th>
            </tr>
        </thead>
        <tbody id="productList"></tbody>
    </table>

    <!-- Ürünleri İndirme Butonu -->
    <button onclick="downloadFile()">Dosyayı İndir</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script>
        let productList = []; // Ürünler burada tutulacak
        let db; // IndexedDB veritabanı
        let editingProductCode = null; // Düzenleme için geçici ürün kodu

        // IndexedDB'i başlat
        function initDB() {
            const request = indexedDB.open("productDatabase", 1);

            request.onupgradeneeded = function(event) {
                db = event.target.result;
                if (!db.objectStoreNames.contains("products")) {
                    db.createObjectStore("products", { keyPath: "productCode" }); // Kasa kodunu anahtar olarak alıyoruz
                }
            };

            request.onsuccess = function(event) {
                db = event.target.result;
                loadProducts();
            };

            request.onerror = function(event) {
                console.error("DB bağlantısı hatası:", event.target.errorCode);
            };
        }

        // Ürünleri veritabanından yükle
        function loadProducts() {
            const transaction = db.transaction(["products"], "readonly");
            const store = transaction.objectStore("products");
            const request = store.getAll(); // Tüm ürünleri al

            request.onsuccess = function(event) {
                productList = event.target.result;
                updateProductTable();
            };
        }

        // Ürünleri tabloya ekle
        function updateProductTable() {
            const tableBody = document.getElementById("productList");
            tableBody.innerHTML = "";

            productList.forEach(product => {
                const row = document.createElement("tr");

                row.innerHTML = `
                    <td>${product.productName}</td>
                    <td>${product.productCode}</td>
                    <td><img src="${product.productImage}" alt="Ürün Resmi" width="50"></td>
                    <td><a href="${product.migrosLink}" target="_blank">Migros Linki</a></td>
                    <td><button onclick="editProduct('${product.productCode}')">Düzenle</button></td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Ürün ekleme fonksiyonu
        function addProduct() {
            const productName = document.getElementById("productName").value;
            const productCode = document.getElementById("productCode").value;
            const productImage = document.getElementById("productImage").value;
            const migrosLink = document.getElementById("migrosLink").value;

            const newProduct = {
                productName,
                productCode,
                productImage,
                migrosLink
            };

            if (editingProductCode) {
                // Düzenleme işlemi
                const index = productList.findIndex(product => product.productCode === editingProductCode);
                if (index !== -1) {
                    productList[index] = newProduct; // Ürünü güncelle
                }
                editingProductCode = null; // Düzenleme bitince sıfırla
            } else {
                // Yeni ürün ekleme
                productList.push(newProduct);
            }

            // Veritabanına ekle veya güncelle
            const transaction = db.transaction(["products"], "readwrite");
            const store = transaction.objectStore("products");
            store.put(newProduct); // put yerine add kullanırsanız, aynı kasa koduyla yeni ekleme yapılmaz

            updateProductTable();
            document.getElementById("productForm").reset();
        }

        // Ürün import fonksiyonu
        function importFile() {
            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0];

            if (file) {
                const reader = new FileReader();

                reader.onload = function(event) {
                    const content = event.target.result;
                    const lines = content.split("\n");

                    // Eski verileri temizle
                    productList = [];

                    lines.forEach(line => {
                        const [productName, productCode, productImage, migrosLink] = line.split(" - ");
                        if (productName && productCode && productImage && migrosLink) {
                            const newProduct = {
                                productName,
                                productCode,
                                productImage,
                                migrosLink
                            };
                            productList.push(newProduct);
                        }
                    });

                    // Veritabanını güncelle ve listeyi yeniden oluştur
                    const transaction = db.transaction(["products"], "readwrite");
                    const store = transaction.objectStore("products");

                    productList.forEach(product => {
                        store.put(product); // Veritabanına yeni ürünleri ekle
                    });

                    // Sayfayı güncelle
                    updateProductTable();
                };

                reader.readAsText(file);
            }
        }

        // Arama fonksiyonu
        function searchProduct() {
            const searchQuery = document.getElementById("searchBar").value.toLowerCase();
            const filteredList = productList.filter(product => {
                return product.productName.toLowerCase().includes(searchQuery) ||
                    product.productCode.toLowerCase().includes(searchQuery) ||
                    product.migrosLink.toLowerCase().includes(searchQuery);
            });
            updateProductTable(filteredList);
        }

        // Ürün listesini .txt olarak indir
        function downloadFile() {
            let fileContent = "";
            productList.forEach(product => {
                fileContent += `${product.productName} - ${product.productCode} - ${product.productImage} - ${product.migrosLink}\n`;
            });

            const blob = new Blob([fileContent], { type: "text/plain" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "urun_listesi.txt";
            link.click();
        }

        // Düzenleme işlemi
        function editProduct(productCode) {
            const product = productList.find(p => p.productCode === productCode);
            if (product) {
                document.getElementById("productName").value = product.productName;
                document.getElementById("productCode").value = product.productCode;
                document.getElementById("productImage").value = product.productImage;
                document.getElementById("migrosLink").value = product.migrosLink;
                editingProductCode = productCode; // Düzenlemeye başla
            }
        }

        // Sayfa yüklendiğinde veritabanını başlat
        window.onload = function() {
            initDB();
        };
    </script>
</body>
</html>